{%- capture type -%}{{ include.type | default:"image"}}{%- endcapture -%}
<figure class="{{ type }} {{ include.class }}">
{% if type contains "image" %}
{% assign img_prefix = include.src | slice:0,4 %}
{% if include.linkurl %}<a href="{{ include.linkurl }}">{% endif %}
{%- capture src -%}{% if img_prefix contains 'http' %}{{include.src}}{% else %}{{ include.src | prepend:'/images/' | relative_url }}{% endif %}{%- endcapture -%}
{%- capture webp_src -%}{{ src }}.webp{%- endcapture -%}
{%- capture alt -%}{% if include.alt %}{{ include.alt }}{% endif %}{%- endcapture -%}
{%- assign is_gif = include.src | downcase | slice: -4, 4 -%}
{% if img_prefix contains 'http' or is_gif == '.gif' %}
  {%- comment -%}External image or GIF, no WebP{%- endcomment -%}
  <img src="{{ src }}" loading="lazy" alt="{{alt}}">
{% elsif jekyll.environment == "production" %}
  {%- comment -%}Production: Use WebP with fallback{%- endcomment -%}
  <picture>
    <source srcset="{{ webp_src }}" type="image/webp">
    <img src="{{ src }}" loading="lazy" alt="{{alt}}">
  </picture>
{% else %}
  {%- comment -%}Development: Use original image only{%- endcomment -%}
  <img src="{{ src }}" loading="lazy" alt="{{alt}}">
{% endif %}
{% if include.title %}<figcaption>{{ include.title | markdownify }}</figcaption>{% endif %}
{% endif %}
{% if include.linkurl %}</a>{% endif %}
{% if type contains "image-with-blurb" %}
{%- capture title -%}{% if include.title %}{% capture level %}{{ include.level | default:4 }}{% endcapture %}{% for i in (1..level) %}#{% endfor %} {{ include.title }}{% endif %}{%- endcapture -%}
{%- capture blurb -%}{% if include.blurb %}{{ include.blurb }}{% endif %}{%- endcapture -%}
<div class="blurb">{{ title | strip | markdownify }}
{{ blurb | strip | markdownify }}</div>
{% endif %}
{% if type contains "audio" %}
{%- assign audio_prefix = include.src | slice:0,4 -%}
{%- capture audio_src -%}{% if audio_prefix contains 'http' %}{{ include.src }}{% else %}{{ include.src | prepend:'/images/' | relative_url }}{% endif %}{%- endcapture -%}
{%- assign audio_ext = include.src | split: "." | last | downcase -%}
{%- if audio_ext == "mp3" -%}{%- assign audio_type = "audio/mpeg" -%}
{%- elsif audio_ext == "ogg" or audio_ext == "opus" -%}{%- assign audio_type = "audio/ogg" -%}
{%- else -%}{%- assign audio_type = "audio/wav" -%}
{%- endif -%}
<audio class="figure-content" controls preload="auto">
  <source src="{{ audio_src }}" type="{{ audio_type }}">
</audio>
{% if include.title %}<figcaption>{{ include.title | markdownify }}</figcaption>{% endif %}
{% if include.transcript %}
<div class="transcript">
  {% assign turns = include.transcript | split: "||" %}
  {% for turn in turns %}
    {% assign turn_stripped = turn | strip %}
    {% assign speaker = turn_stripped | split: ": " | first %}
    {% assign text = turn_stripped | replace_first: speaker, "" | remove_first: ": " %}
    {% if speaker == "Google" %}{% assign speaker_class = "speaker-google" %}{% elsif speaker == "Me" %}{% assign speaker_class = "speaker-me" %}{% else %}{% assign speaker_class = "speaker-caller" %}{% endif %}
    <div class="transcript-turn {{ speaker_class }}">
      <span class="transcript-text">{{ text }}</span>
      <span class="speaker-label">{{ speaker }}</span>
    </div>
  {% endfor %}
</div>
{% endif %}
{% endif %}
{% if type contains "iframe" %}
{% if include.src contains 'youtube.com' or include.src contains 'youtu.be' %}
{% comment %}Youtube. Make it a lazy loader... {% endcomment %}
<div data-src="{{ include.src|replace:'http:','' }}" class="figure-content placeholder" width="600" height="350">
    <img src="https://img.youtube.com/vi/{{ include.src|split:'/'|last|split:'?'|first}}/0.jpg" loading="lazy"/>
</div>
{% else %}
{% comment %}Some other sort of iframe then... {% endcomment %}
<iframe class="figure-content" src="{{ include.src|replace:'http:','' }}" width="600" height="350"></iframe>
{% endif %}
{% endif %}
</figure>
